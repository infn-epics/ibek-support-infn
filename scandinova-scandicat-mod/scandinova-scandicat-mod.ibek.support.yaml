# yaml-language-server: $schema=https://github.com/epics-containers/ibek/releases/download/3.1.2/ibek.support.schema.json

module: scandinova-scandicat-mod

entity_models:
  - name: RFModulator
    description: |-
      Create a Scandinova RF Modulator controller using Modbus TCP/IP
      This uses the lite configuration which excludes optional registers not present on all hardware:
      - Klystron RF monitoring (registers 820-826)
      - CCPS cooling flow sensors (registers 900-906)
      - Additional flow sensors (registers 908-912)
    parameters:
      name:
        type: id
        description: |-
          The modulator identifier (e.g., "1", "2", "3")

      P:
        type: str
        description: |-
          Device PV Prefix (e.g., "MODHEL01")

      SLAVE_ADDR:
        type: int
        description: |-
          Modbus slave address
        default: 1

      IP:
        type: str
        description: |-
          IP address or hostname of the RF Modulator

      TCPPORT:
        type: int
        description: |-
          TCP port of the Modbus interface
        default: 502

      POLLING:
        type: int
        description: |-
          Standard polling time in ms for most registers
        default: 4000

      WD_POLLING:
        type: int
        description: |-
          Watchdog read polling time in ms
        default: 2000

      WD_WRITE_POLLING:
        type: int
        description: |-
          Watchdog write polling time in ms
        default: 800

      CCPS_V_SP_HOPR:
        type: int
        description: |-
          CCPS voltage setpoint high operating range
        default: 1500

      PLS_WDTH_SP_HOPR:
        type: int
        description: |-
          Pulse width setpoint high operating range
        default: 5

      FILPS_CURR_SP_HOPR:
        type: int
        description: |-
          Filament current setpoint high operating range
        default: 30

      IONPMP_HIGH:
        type: int
        description: |-
          Ion pump HIGH alarm threshold
        default: 8000

      IONPMP_HIHI:
        type: int
        description: |-
          Ion pump HIHI alarm threshold
        default: 9000

    pre_init:
      - value: |
          #############################################################################
          # Scandinova RF Modulator {{name}} - Lite Configuration
          # Excludes optional registers not present on all hardware:
          # - Klystron RF monitoring (registers 820-826)
          # - CCPS cooling flow sensors (registers 900-906)
          # - Additional flow sensors (registers 908-912)
          #############################################################################
          epicsEnvSet("RFMOD_ASYNPORT", "RFMod_{{name}}")
          epicsEnvSet("RFMOD_MSGS", "SCN_RFMod_{{name}}")
          epicsEnvSet("RFMOD_POLLING", "{{POLLING}}")
          epicsEnvSet("RFMOD_WD_POLLING", "{{WD_POLLING}}")
          
          ## TCP/IP port
          drvAsynIPPortConfigure("RFMod_{{name}}", "{{IP}}:{{TCPPORT}}", 0, 0, 1)
          modbusInterposeConfig("RFMod_{{name}}", 0, 2000, 0)
          
          ## Core TCP/Status registers (Function 4 - Read Input Registers)
          drvModbusAsynConfigure("RFMod_{{name}}_TCP_PROT_ID",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 0,  1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_TCP_PROT_REV",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 1,  1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_TCP_WD_PREV",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 2,  1, 0, {{WD_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_STATE_RB",      "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 3,  1, 4, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_STATUS_RB",     "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 4,  1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_ACC_LVL_RB",    "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 5,  1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_TIME_REMAINING", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 6,  2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Status / Protocol derived PVs
          drvModbusAsynConfigure("RFMod_{{name}}_PLS_REP_RATE", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 8, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Setpoint readbacks
          drvModbusAsynConfigure("RFMod_{{name}}_STATE_SR",       "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 20, 1, 4, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS_VOLT_SR",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 21, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_FILPS_CURR_SR",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 23, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_PLS_WDTH_SR",    "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 25, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## CCPS voltages
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS1_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 100, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS2_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 102, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS3_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 104, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Filament PS
          drvModbusAsynConfigure("RFMod_{{name}}_FILPS_CURR", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 200, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_FILPS_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 202, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Ion pump
          drvModbusAsynConfigure("RFMod_{{name}}_IONPS_R", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 300, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Solenoid PS
          drvModbusAsynConfigure("RFMod_{{name}}_SOLPS_CURR", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 400, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_SOLPS_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 402, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Pulse measurements
          drvModbusAsynConfigure("RFMod_{{name}}_PLS_CURR", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 500, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_PLS_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 502, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_PLS_WDTH", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 504, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Tank oil
          drvModbusAsynConfigure("RFMod_{{name}}_OIL_TEMP",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 600, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_OIL_LVL", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 602, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Temperatures
          drvModbusAsynConfigure("RFMod_{{name}}_INLETTEMP",     "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 700, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_OUTLETTEMP",    "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 702, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_SOLPSTEMP",     "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 704, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_KLYBDRTNTEMP",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 706, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## REMOVED: Klystron RF monitoring (registers 820-826) - not present on all hardware
          ## REMOVED: CCPS cooling flow sensors (registers 900-906) - not present on all hardware
          ## REMOVED: Body/Collector/Solenoid flow (registers 908-912) - not present on all hardware
          
          ## CCPS interlocks (split per register to avoid exception=3 on length>1)
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS1_ILCKS", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 120, 1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS2_ILCKS", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 121, 1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS3_ILCKS", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 122, 1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Outputs (Function 6/16 - Write Holding Registers)
          drvModbusAsynConfigure("RFMod_{{name}}_WD_SP",         "RFMod_{{name}}", {{SLAVE_ADDR}}, 6,  0,   1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_STATE_SP",      "RFMod_{{name}}", {{SLAVE_ADDR}}, 6,  1,   1, 4, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_CMD_SP",        "RFMod_{{name}}", {{SLAVE_ADDR}}, 6,  2,   1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS_VOLT_SP",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 16, 100, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_FILPS_CURR_SP", "RFMod_{{name}}", {{SLAVE_ADDR}}, 16, 200, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_PLS_WDTH_SP",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 16, 300, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Enable ASYN_TRACEIO_HEX on octet server
          asynSetTraceIOMask("RFMod_{{name}}", 0, 4)

    databases:
      - file: $(SCANDINOVA_RFMOD)/db/scandinova-rfmod-lite.db
        args:
          RFMOD_ASYNPORT: 'RFMod_{{name}}'
          PREFIX: '{{P}}'
          CCPS_V_SP_HOPR: '{{CCPS_V_SP_HOPR}}'
          PLS_WDTH_SP_HOPR: '{{PLS_WDTH_SP_HOPR}}'
          FILPS_CURR_SP_HOPR: '{{FILPS_CURR_SP_HOPR}}'
          IONPMP_HIGH: '{{IONPMP_HIGH}}'
          IONPMP_HIHI: '{{IONPMP_HIHI}}'

    post_init:
      - value: |
          ## Optional: Print database record list for modulator {{name}}
          # dbl
