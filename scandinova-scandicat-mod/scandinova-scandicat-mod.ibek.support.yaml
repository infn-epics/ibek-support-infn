# yaml-language-server: $schema=https://github.com/epics-containers/ibek/releases/download/3.1.2/ibek.support.schema.json

module: scandinova-scandicat-mod

entity_models:
  - name: RFModulator
    description: |-
      Create a Scandinova RF Modulator controller using Modbus TCP/IP
      This uses the split-debug configuration with individual ports per register group
    parameters:
      name:
        type: id
        description: |-
          The modulator identifier (e.g., "1", "2", "3")

      P:
        type: str
        description: |-
          Device PV Prefix (e.g., "MODHEL01")

      SLAVE_ADDR:
        type: int
        description: |-
          Modbus slave address
        default: 1

      IP:
        type: str
        description: |-
          IP address or hostname of the RF Modulator

      TCPPORT:
        type: int
        description: |-
          TCP port of the Modbus interface
        default: 502

      POLLING:
        type: int
        description: |-
          Standard polling time in ms for most registers
        default: 4000

      WD_POLLING:
        type: int
        description: |-
          Watchdog read polling time in ms
        default: 2000

      WD_WRITE_POLLING:
        type: int
        description: |-
          Watchdog write polling time in ms
        default: 800

      SLOW_REGISTER_POLLING:
        type: int
        description: |-
          Slow register polling time in ms (RF, Flow meters)
        default: 5000

      TEST_POLLING:
        type: int
        description: |-
          Test probe polling time in ms
        default: 10000

      CCPS_V_SP_HOPR:
        type: int
        description: |-
          CCPS voltage setpoint high operating range
        default: 1500

      PLS_WDTH_SP_HOPR:
        type: int
        description: |-
          Pulse width setpoint high operating range
        default: 5

      FILPS_CURR_SP_HOPR:
        type: int
        description: |-
          Filament current setpoint high operating range
        default: 30

      IONPMP_HIGH:
        type: int
        description: |-
          Ion pump HIGH alarm threshold
        default: 8000

      IONPMP_HIHI:
        type: int
        description: |-
          Ion pump HIHI alarm threshold
        default: 9000

    pre_init:
      - value: |
          #############################################################################
          # Scandinova RF Modulator {{name}} - Split Debug Configuration
          #############################################################################
          epicsEnvSet("RFMOD_ASYNPORT", "RFMod_{{name}}")
          epicsEnvSet("RFMOD_MSGS", "SCN_RFMod_{{name}}")
          
          ## TCP/IP port
          drvAsynIPPortConfigure("RFMod_{{name}}", "{{IP}}:{{TCPPORT}}", 0, 0, 1)
          modbusInterposeConfig("RFMod_{{name}}", 0, 0, 1)
          
          ## Core TCP/Status registers (Function 4 - Read Input Registers)
          drvModbusAsynConfigure("RFMod_{{name}}_TCP_PROT_ID",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 0,  1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_TCP_PROT_REV",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 1,  1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_TCP_WD_PREV",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 2,  1, 0, {{WD_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_STATE_RB",      "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 3,  1, 4, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_STATUS_RB",     "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 4,  1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_ACC_LVL_RB",    "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 5,  1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_TIME_REMAINING", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 6,  2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Status / Protocol derived PVs
          drvModbusAsynConfigure("RFMod_{{name}}_READ_PLS_REPR_RB", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 8, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Setpoint readbacks
          drvModbusAsynConfigure("RFMod_{{name}}_STATE_SR",               "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 20, 1, 4, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_CCPS_VOLT_SET_RB",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 21, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FILPS_CURR_SET_RB", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 23, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_PLS_WDTH_SET_RB",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 25, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Mirrored setpoint readbacks
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS_VOLT_SR",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 21, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_FILPS_CURR_SR", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 23, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_PLS_WDTH_SR",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 25, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## CCPS voltages
          drvModbusAsynConfigure("RFMod_{{name}}_READ_CCPS1_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 100, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_CCPS2_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 102, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_CCPS3_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 104, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Filament PS
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FILPS_CURR", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 200, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FILPS_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 202, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Ion pump
          drvModbusAsynConfigure("RFMod_{{name}}_READ_IONPS_R", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 300, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Solenoid PS
          drvModbusAsynConfigure("RFMod_{{name}}_READ_SOLPS_CURR", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 400, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_SOLPS_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 402, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Pulse measurements
          drvModbusAsynConfigure("RFMod_{{name}}_READ_PLS_CURR", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 500, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_PLS_VOLT", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 502, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_PLS_WDTH", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 504, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Tank oil
          drvModbusAsynConfigure("RFMod_{{name}}_READ_TANK_TEMP",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 600, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_TANK_LEVEL", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 602, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Temperatures
          drvModbusAsynConfigure("RFMod_{{name}}_READ_CLL_IN_TEMP",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 700, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_CLL_OUT_TEMP", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 702, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_SOLPS_TEMP",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 704, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_KLY_OUT_TEMP", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 706, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## RF measurements (slow polling)
          drvModbusAsynConfigure("RFMod_{{name}}_READ_RF_FWD",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 820, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_RF_REFL", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 822, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_RF_VSWR", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 824, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_RF_PLEN", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 826, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Flows (slow polling)
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FLOW_CCPS1", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 900, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FLOW_CCPS2", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 902, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FLOW_CCPS3", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 904, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FLOW_CCPS4", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 906, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FLOW_BODY",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 908, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FLOW_CLL",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 910, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_FLOW_SOLPS", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 912, 2, 7, {{SLOW_REGISTER_POLLING}}, "SCN_RFMod_{{name}}")
          
          ## CCPS interlocks combined block (disabled - device rejects len>1)
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS_ILCKS", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 120, 3, 0, 0, "SCN_RFMod_{{name}}")
          
          ## CCPS interlocks (split per register to avoid exception=3 on length>1)
          drvModbusAsynConfigure("RFMod_{{name}}_READ_CCPS1_ILCKS", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 120, 1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_CCPS2_ILCKS", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 121, 1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_READ_CCPS3_ILCKS", "RFMod_{{name}}", {{SLAVE_ADDR}}, 4, 122, 1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          
          ## Outputs (Function 6/16 - Write Holding Registers)
          drvModbusAsynConfigure("RFMod_{{name}}_WD_SP",         "RFMod_{{name}}", {{SLAVE_ADDR}}, 6,  0,   1, 0, {{WD_WRITE_POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_STATE_SP",      "RFMod_{{name}}", {{SLAVE_ADDR}}, 6,  1,   1, 4, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_CMD_SP",        "RFMod_{{name}}", {{SLAVE_ADDR}}, 6,  2,   1, 0, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_CCPS_VOLT_SP",  "RFMod_{{name}}", {{SLAVE_ADDR}}, 16, 100, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_FILPS_CURR_SP", "RFMod_{{name}}", {{SLAVE_ADDR}}, 16, 200, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")
          drvModbusAsynConfigure("RFMod_{{name}}_PLS_WDTH_SP",   "RFMod_{{name}}", {{SLAVE_ADDR}}, 16, 300, 2, 7, {{POLLING}}, "SCN_RFMod_{{name}}")

    databases:
      - file: $(SCANDINOVA_RFMOD)/db/scandinova-rfmod-split-debug.db
        args:
          RFMOD_ASYNPORT: 'RFMod_{{name}}'
          PREFIX: '{{P}}'
          CCPS_V_SP_HOPR: '{{CCPS_V_SP_HOPR}}'
          PLS_WDTH_SP_HOPR: '{{PLS_WDTH_SP_HOPR}}'
          FILPS_CURR_SP_HOPR: '{{FILPS_CURR_SP_HOPR}}'
          IONPMP_HIGH: '{{IONPMP_HIGH}}'
          IONPMP_HIHI: '{{IONPMP_HIHI}}'

    post_init:
      - value: |
          ## Optional: Print database record list for modulator {{name}}
          # dbl
