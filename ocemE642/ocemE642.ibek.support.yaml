# yaml-language-server: $schema=https://github.com/epics-containers/ibek/releases/download/3.1.2/ibek.support.schema.json

module: ocem

entity_models:

  # ---------------------------------------------------------------------
  # GROUP ENTITY — inizializzazione cumulativa del driver
  # ---------------------------------------------------------------------
  - name: E642Group
    description: |-
      Controller for an OCEM E642 chain of slaves.
      Configures the ASYN IP port and initializes the OCEM driver.

    parameters:
      P:
        type: str
        description: Device prefix

      NAME:
        type: str
        description: Logical name of this E642 controller

      IP:
        type: str
        description: Controller IP address

      TCPPORT:
        type: int
        description: Controller IP port
        default: 502

      SLAVELIST:
        type: str
        description: "Comma-separated list of slave IDs"

      INIT_TIMEOUT_S:
        type: float
        description: "Timeout for each PS init before retry (seconds)"
        default: 5.0

      INIT_MAX_RETRIES:
        type: int
        description: "Max retries before marking PS failed"
        default: 3

      IDLE_POLL_S:
        type: float
        description: "Polling interval when no commands active (seconds)"
        default: 0.2

      ACTIVE_POLL_S:
        type: float
        description: "Polling interval when commands are being processed (seconds)"
        default: 0.1

      ACTIVE_TIMEOUT_S:
        type: float
        description: "How long to stay in active mode after last command (seconds)"
        default: 5.0

      DEBUG_LEVEL:
        type: int
        description: "Debug level: 0=Errors, 1=Basic, 2=Protocol, 3=Full trace"
        default: 0

    pre_init:
      - value: |
          drvAsynIPPortConfigure("{{NAME}}_ASYN", "{{IP}}:{{TCPPORT}}", 0,0,0)
          ocemInit "{{NAME}}_ASYN","{{SLAVELIST}}"
          ocemSetInitParams {{INIT_TIMEOUT_S}}, {{INIT_MAX_RETRIES}}
          ocemSetPollingRates {{IDLE_POLL_S}}, {{ACTIVE_POLL_S}}, {{ACTIVE_TIMEOUT_S}}
          ocemSetDebug {{DEBUG_LEVEL}}

    # Nessun database qui (solo init)
    databases: []


  # ---------------------------------------------------------------------
  # SLAVE ENTITY — uno per ogni canale
  # ---------------------------------------------------------------------
  - name: E642
    description: |-
      Single OCEM E642 slave channel.
      Supports UNIMAG state machine for automatic current/polarity control.

    parameters:
      P:
        type: str
        description: Device prefix

      R:
        type: str
        description: "Geographical/logical name of the slave"

      NAME:
        type: str
        description: "Must match the controller NAME for ASYN port"

      ADDR:
        type: int
        description: "Slave ID"

      IMAX:
        description: Max Current for this slave (Amperes)
        type: float
        default: 280

      VMAX:
        description: Max Voltage for this slave (Volts)
        type: float
        default: 40

      SET_TOLERANCE:
        description: "Tolerance for current setpoint verification (Amperes)"
        type: float
        default: 1.8

      ZERO_TOLERANCE:
        description: "Tolerance for zero current check (Amperes)"
        type: float
        default: 1.8

      SET_TIMEOUT_S:
        description: "Timeout for reaching setpoint (seconds)"
        type: float
        default: 60.0

      INIT_TIMEOUT_S:
        description: "Timeout before retrying PRG initialization (seconds)"
        type: float
        default: 60.0

      CURRENT_THRESHOLD:
        description: "Current threshold for unsolicited messages (A). "
        type: float
        default: 99999

      VOLTAGE_THRESHOLD:
        description: "Voltage threshold for unsolicited messages (V)."
        type: float
        default: 999

      POLL_STATE:
        description: "Enable periodic SL (state) polling: 0=disabled, 1=enabled"
        type: int
        default: 1

      POLL_STATE_INTERVAL:
        description: "SL polling interval (seconds)"
        type: float
        default: 1.0

      POLL_ANALOG:
        description: "Enable periodic SA (analog) polling: 0=disabled, 1=enabled"
        type: int
        default: 1

      POLL_ANALOG_INTERVAL:
        description: "SA polling interval (seconds)"
        type: float
        default: 0.5

    databases:
      - file: OCEM_E642.db
        args:
          P:
          R:
          ADDR:
          IMAX:
          VMAX:
          SET_TOLERANCE:
          ZERO_TOLERANCE:
          SET_TIMEOUT_S:
          INIT_TIMEOUT_S:
          CURRENT_THRESHOLD:
          VOLTAGE_THRESHOLD:
          POLL_STATE:
          POLL_STATE_INTERVAL:
          POLL_ANALOG:
          POLL_ANALOG_INTERVAL:


  